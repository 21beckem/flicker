<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flicker Mate</title>
    <script src="https://kit.fontawesome.com/5ab05bade1.js" crossorigin="anonymous"></script>
    <style>
html, body {
    background-color: black;
    color: white;
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
}
watchbody {
    width: 450px;
    height: 450px;
    align-items: center;
    text-align: center;
    border: 1px solid white;
    display: block;
    position: relative;
    font-size: xx-large;
}
    </style>
</head>
<body>
    <watchbody>
        <br>
        <div id="statusElm"><i class="fa-solid fa-link-slash"></i></div>
        <br>
        <div id="gyroCountElm">Gyro: 0</div>
        <div id="acelCountElm">Acel: 0</div>
    </watchbody>
    <script src="/socket.io/socket.io.js"></script>
    <script>
// get unique id for this browser
const browId = localStorage.getItem('browId') || Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
localStorage.setItem('browId', browId);
console.log('browId:', browId);

async function turnOnWakeLock(){try{wakeLock = await navigator.wakeLock.request("screen");}catch(err){alert('Wake Lock not supported');}}
let gyroData = {};
let acelData = {};
let gyroCount = 0;
let acelCount = 0;

function readSensors() {
    const gyro = new Gyroscope({ frequency: 60 });
    gyro.addEventListener("reading", (e) => {
        gyroData = {x: gyro.x, y: gyro.y, z: gyro.z};
        gyroCount++;
        gyroCountElm.innerHTML = 'Gyro: ' + gyroCount;
    });
    gyro.start();

    const acel = new Accelerometer({ frequency: 60 });
    acel.addEventListener("reading", () => {
        acelData = {x: acel.x, y: acel.y, z: acel.z};
        acelCount++;
        acelCountElm.innerHTML = 'Acel: ' + acelCount;
    });
    acel.start();

    // Send data at 60Hz
    setInterval(() => {
        socket.emit('sensor-data', {
            gyro: gyroData,
            acel: acelData,
        });
    }, 1000 / 60);
}

function init() {
    socket.on("connect", () => {
        statusElm.innerHTML = '<i class="fa-solid fa-link"></i>';
        socket.emit('set-brow-id', browId);
    });
    
    socket.on("disconnect", () => {
        statusElm.innerHTML = '<i class="fa-solid fa-link-slash"></i>';
    });
    
    readSensors();
}
const socket = io();
init();
turnOnWakeLock();
    </script>
</body>
</html>